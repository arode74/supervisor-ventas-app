<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APP Ventas | Cambiar contraseña</title>

  <!-- ✅ MISMO FORMATO QUE LOGIN -->
  <link rel="stylesheet" href="../styles/login.css" />

  <style>
    /* Overlay centrado */
    #overlayCarga{
      position:fixed; inset:0; z-index:10000;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
    }
    #overlayCarga.oculto{display:none!important}
    #overlayCarga .caja-carga{
      min-width:320px; max-width:520px; width:calc(100vw - 48px);
      background:#fff; border-radius:14px;
      padding:16px 18px;
      box-shadow:0 18px 60px rgba(0,0,0,.25);
      text-align:center; color:#0b1f33;
    }
    #overlayCarga .spinner{ margin:0 auto 10px auto; }

    /* Toast modal con botón (mismo patrón que login) */
    #toast.toast{
      position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%);
      z-index:10050;
      min-width:320px; max-width:560px; width:calc(100vw - 48px);
      border-radius:14px; background:#fff;
      box-shadow:0 18px 60px rgba(0,0,0,.25);
      outline:9999px solid rgba(0,0,0,.35);
      padding:0;
    }
    #toast.toast:empty{ display:none!important; outline:none!important; }
    .toast-inner{
      display:flex;
      flex-direction:column;         /* ✅ botón abajo */
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:14px 16px;
      color:#0b1f33;
      text-align:center;
    }
    .toast-msg{ font-size:14px; line-height:1.25; }
    .toast-close{
      border:0; border-radius:10px;
      padding:8px 14px;
      cursor:pointer;
      background:#0b4a7a;
      color:#fff;
      font-weight:600;
      white-space:nowrap;
      width:fit-content;
    }

    /* ✅ Ajustes específicos de la pantalla cambio password manteniendo formato login */
    .login-container h2{
      margin-bottom: 10px;
    }
    .subtexto{
      font-size: 13px;
      color: #1c3550;
      margin: 0 0 18px;
      line-height: 1.35;
    }

    /* Botones Guardar/Cancelar como línea doble */
    .acciones-dos-botones{
      width:100%;
      display:flex;
      gap:12px;
      margin-top: 6px;
    }
    .acciones-dos-botones button{
      flex:1;
      border:none;
      border-radius:6px;
      padding:10px;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-primario{
      background:#0056a1;
      color:#fff;
    }
    .btn-primario:hover{ background:#003f73; }
    .btn-secundario{
      background:#f3f7ff;
      color:#004a91;
      border:1px solid #c7d6e8 !important;
    }
    .btn-secundario:hover{ background:#e9f1ff; }

    .nota-seguridad{
      margin-top: 14px;
      font-size: 12px;
      color: #6b7785;
      text-align: center;
    }

    /* Spinner simple */
    .spinner{
      width:26px; height:26px;
      border:3px solid #d7e3f1;
      border-top-color:#0056a1;
      border-radius:50%;
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div class="login-container">
    <img src="../assets/logo_app_ventas.png" alt="APP Ventas" />

    <h2>Cambio de contraseña</h2>
    <p class="subtexto">
      Tu cuenta fue creada con una contraseña temporal. Define una nueva para continuar.
    </p>

    <form id="formCambioPassword" autocomplete="off">
      <label for="nuevaPassword">Nueva contraseña</label>
      <div class="input-wrap">
        <input
          type="password"
          id="nuevaPassword"
          name="nuevaPassword"
          minlength="10"
          placeholder="Mínimo 10 caracteres"
          required
          autocomplete="new-password"
        />
        <button type="button" class="btn-eye" data-eye-for="nuevaPassword"
          aria-label="Mantén presionado para ver" title="Mantén presionado para ver">
          <svg class="eye-closed" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 3l18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10.6 10.6a3 3 0 004.24 4.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M9.9 5.1A11.5 11.5 0 0121 12a11.6 11.6 0 01-2.7 3.8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M6.2 6.2A11.6 11.6 0 003 12a11.5 11.5 0 006.4 6.2A11.5 11.5 0 0012 18c1.2 0 2.4-.2 3.5-.6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <svg class="eye-open" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>
      </div>

      <label for="confirmarPassword">Confirmar contraseña</label>
      <div class="input-wrap">
        <input
          type="password"
          id="confirmarPassword"
          name="confirmarPassword"
          minlength="10"
          placeholder="Repite la nueva contraseña"
          required
          autocomplete="new-password"
        />
        <button type="button" class="btn-eye" data-eye-for="confirmarPassword"
          aria-label="Mantén presionado para ver" title="Mantén presionado para ver">
          <svg class="eye-closed" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 3l18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10.6 10.6a3 3 0 004.24 4.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M9.9 5.1A11.5 11.5 0 0121 12a11.6 11.6 0 01-2.7 3.8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M6.2 6.2A11.6 11.6 0 003 12a11.5 11.5 0 006.4 6.2A11.5 11.5 0 0012 18c1.2 0 2.4-.2 3.5-.6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <svg class="eye-open" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>
      </div>

      <div class="acciones-dos-botones">
        <button type="submit" id="btnGuardar" class="btn-primario">Guardar</button>
        <button type="button" id="btnCancelar" class="btn-secundario">Cancelar</button>
      </div>

      <p class="nota-seguridad">
        Recomendación: usa una frase larga o mezcla de letras, números y símbolos.
      </p>
    </form>

    <footer>© APP Ventas</footer>
  </div>

  <div id="overlayCarga" class="oculto" aria-hidden="true">
    <div class="caja-carga">
      <div class="spinner"></div>
      <div id="mensajeCarga">Procesando...</div>
    </div>
  </div>

  <div id="toast" class="toast" role="dialog" aria-live="polite"></div>

  <script>
    // Adaptador toast: texto plano -> modal con botón cerrar (centrado abajo)
    (function () {
      const toast = document.getElementById("toast");
      if (!toast) return;

      function renderModalFromText(text) {
        const msg = (text || "").trim();
        if (!msg) { toast.innerHTML = ""; return; }
        toast.innerHTML = `
          <div class="toast-inner">
            <div class="toast-msg">${msg.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
            <button type="button" class="toast-close" id="toastCloseBtn">Cerrar</button>
          </div>
        `;
        const btn = document.getElementById("toastCloseBtn");
        if (btn) btn.onclick = () => (toast.innerHTML = "");
      }

      const obs = new MutationObserver(() => {
        if (toast.querySelector(".toast-close")) return;
        const plain = toast.textContent || "";
        if (plain.trim() && toast.children.length === 0) renderModalFromText(plain);
      });

      obs.observe(toast, { childList: true, characterData: true, subtree: true });
    })();

    // Press & Hold: mostrar/ocultar contraseña
    (function () {
      function attachPressHold(btn) {
        const inputId = btn.getAttribute("data-eye-for");
        const input = document.getElementById(inputId);
        if (!input) return;

        const show = () => { input.type = "text"; btn.classList.add("is-open"); };
        const hide = () => { input.type = "password"; btn.classList.remove("is-open"); };

        btn.addEventListener("mousedown", (e) => { e.preventDefault(); show(); });
        btn.addEventListener("mouseup", hide);
        btn.addEventListener("mouseleave", hide);

        btn.addEventListener("touchstart", (e) => { e.preventDefault(); show(); }, { passive: false });
        btn.addEventListener("touchend", hide);
        btn.addEventListener("touchcancel", hide);

        window.addEventListener("blur", hide);
        document.addEventListener("visibilitychange", () => { if (document.hidden) hide(); });
      }

      document.querySelectorAll("[data-eye-for]").forEach(attachPressHold);
    })();
  </script>

  <!-- ✅ CRÍTICO: ruta correcta desde /views -->
  <script src="../env.js"></script>

  <!-- Módulo principal -->
  <script type="module" src="../scripts/cambiar-password.js"></script>
</body>
</html>
