<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>M√≥dulo Compromisos ‚Äì APP Ventas</title>

  <script src="../env.js"></script>

  <!-- Estilos institucionales -->
  <link rel="stylesheet" href="../styles/institucional.css" />
  <link rel="stylesheet" href="../styles/panel-base.css" />
  <link rel="stylesheet" href="../styles/panel-base-responsive.css" />

  <style>
    /* Mantener el rango de semana en una l√≠nea */
    #labelRangoSemana {
      white-space: nowrap !important;
      display: inline-block !important;
    }

    /* Tabs del modal */
    .tabs-modal {
      display:flex;
      gap:8px;
      margin: 10px 0 12px 0;
    }
    .tabs-modal .tab-btn{
      border: 1px solid rgba(0,0,0,0.15);
      background: #f2f4f7;
      padding: 6px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-weight:600;
      font-size: 0.9rem;
    }
    .tabs-modal .tab-btn.active{
      background: #ffffff;
      border-color: rgba(0,0,0,0.25);
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
    }
    .sheet { display:none; }
    .sheet.active { display:block; }

    /* Marcos Mensual / Semanal (se aplican por clases inyectadas desde JS) */
    th.grp-mensual, th.grp-semanal{
      text-align:center;
      font-weight:700;
    }

    /* Compactar solo columnas Mensual/Semanal */
    th.col-mensual, td.col-mensual,
    th.col-semanal, td.col-semanal{
      font-size: 0.85rem;
      padding: 4px 6px !important; line-height: 1.1;
      white-space: nowrap;
    }

    td.col-mensual, td.col-semanal{ text-align: center; }

    /* Bordes de marco (izq/der) */
    th.mensual-start, td.mensual-start { border-left: 2px solid rgba(33, 150, 243, 0.10) !important; }
    th.mensual-end,   td.mensual-end   { border-right:2px solid rgba(33, 150, 243, 0.10) !important; }

    th.semanal-start, td.semanal-start { border-left: 2px solid rgba(33, 150, 243, 0.10) !important; }
    th.semanal-end,   td.semanal-end   { border-right:2px solid rgba(33, 150, 243, 0.10) !important; }

    /* Bordes superiores para que se vea el marco */
    thead tr.grp th.grp-mensual,
    thead tr.grp th.grp-semanal{
      border-top: 2px solid rgba(33, 150, 243, 0.10) !important;
    }
    thead tr.cols th.col-mensual,
    thead tr.cols th.col-semanal{
      border-top: 2px solid rgba(33, 150, 243, 0.10) !important;
    }

    /* Bordes inferiores (cierra el marco visual) */
    td.col-mensual, td.col-semanal{
      border-bottom: 2px solid rgba(33, 150, 243, 0.08);
    }

    /* Compactar alto de fila general (~80%) */
    #tablaCompromisos tbody td{
      padding-top: 6px !important;
      padding-bottom: 6px !important;
    }
    #tablaCompromisos tbody td.col-mensual,
    #tablaCompromisos tbody td.col-semanal{
      padding-top: 4px !important;
      padding-bottom: 4px !important;
    }
  
    /* Compactar a√∫n m√°s la fila del nombre del vendedor */
    #tablaCompromisos tbody td:first-child{
      padding-top: 4px !important;
      padding-bottom: 4px !important;
      line-height: 1.05;
    }


    /* Compactar TODA la fila de vendedores (igual a Mensual/Semanal) */
    #tablaCompromisos tbody tr.fila-vendedor td{
      padding-top: 4px !important;
      padding-bottom: 4px !important;
      line-height: 1.05;
    }


    /* Tabs modal: celeste claro / celeste oscuro activo */
    .tabs-modal .tab-btn{
      background: rgba(33,150,243,0.12);
      border: 1px solid rgba(33,150,243,0.25);
      color: #ffffff;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .tabs-modal .tab-btn.active{
      background: rgba(33,150,243,0.85);
      border-color: rgba(33,150,243,0.9);
      color: #ffffff;
      box-shadow: none;
    }


    /* ===== DIMENSIONES DEFINITIVAS SOLICITADAS (CORREGIDO) =====
       Objetivo:
       - SOLO Vendedor = 40% (no afectar el resto como %)
       - Acciones = 40px
       - El resto (11 columnas num√©ricas) se reparte autom√°tico dentro del margen
    */

    #tablaCompromisos{
      width:840px;
      max-width:840px;
      table-layout:fixed;
      font-size:0.78rem;
      font-variant-numeric:tabular-nums;

      --w-vendedor: 173px;
      --w-acciones: 18px;
      --n-cols-num: 11;
      --w-num: 59px;
    }

    /* Headers centrados */
    #tablaCompromisos thead th{
      text-align:center !important;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Subt√≠tulos (TF/Sobre/Tope/Plan...) un poco m√°s chicos para que no se pisen */
    #tablaCompromisos thead tr:nth-child(2) th{
      font-size:0.70rem;
      letter-spacing:0.2px;
      overflow:visible;
      text-overflow:clip;
    }

    /* Body centrado (n√∫meros) */
    #tablaCompromisos tbody td{
      text-align:center !important;
      white-space:nowrap;
    }

    /* ===== VENDEDOR (SOLO esta columna en %) ===== */
    #tablaCompromisos thead th:first-child{
      text-align:left !important;
      width: var(--w-vendedor);
    }

    #tablaCompromisos tbody td:first-child{
      text-align:left !important;
      font-weight:600;
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      width: var(--w-vendedor);
    }

    /* ===== ACCIONES (px fijo) ===== */
    #tablaCompromisos thead th:last-child,
    #tablaCompromisos tbody td:last-child{
      width: var(--w-acciones);
      min-width: var(--w-acciones);
      max-width: var(--w-acciones);
      text-align:center !important;
      overflow:visible;      /* que el t√≠tulo ‚ÄúAcciones‚Äù no se corte raro */
      text-overflow:clip;
      white-space:nowrap;
    }

    /* ===== COLUMNAS NUM√âRICAS (auto dentro del margen) ===== */
    #tablaCompromisos thead th:not(:first-child):not(:last-child),
    #tablaCompromisos tbody td:not(:first-child):not(:last-child){
      width: var(--w-num);
      min-width: 52px;       /* piso para que se lean 2 d√≠gitos */
      max-width: 90px;       /* techo para que no se desbalancee */
      text-align:center !important;
    }

    /* ===== L√≠neas divisorias por grupo (Mensual / Semanal / Real) =====
       Estructura esperada:
       1 Vendedor
       2-5 Mensual (4)
       6-9 Semanal (4)
       10-12 Real (3)
       13 Acciones
    */
    #tablaCompromisos th:nth-child(2),
    #tablaCompromisos td:nth-child(2),
    #tablaCompromisos th:nth-child(6),
    #tablaCompromisos td:nth-child(6),
    #tablaCompromisos th:nth-child(10),
    #tablaCompromisos td:nth-child(10),
    #tablaCompromisos th:nth-child(13),
    #tablaCompromisos td:nth-child(13){
      border-left:2px solid rgba(25,84,140,0.18);
    }

    #tablaCompromisos th:nth-child(5),
    #tablaCompromisos td:nth-child(5),
    #tablaCompromisos th:nth-child(9),
    #tablaCompromisos td:nth-child(9),
    #tablaCompromisos th:nth-child(12),
    #tablaCompromisos td:nth-child(12){
      border-right:2px solid rgba(25,84,140,0.18);
    }

    
    /* Cierre visual del grupo REAL (faltaba el borde derecho) */
    #tablaCompromisos th.real-start,
    #tablaCompromisos td.real-start{
      border-left:2px solid rgba(25,84,140,0.18);
    }
    #tablaCompromisos th.real-end,
    #tablaCompromisos td.real-end{
      border-right:2px solid rgba(25,84,140,0.18);
    }

/* Real: t√≠tulo centrado */
    #tablaCompromisos thead th.grp-real,
    #tablaCompromisos thead th[colspan="3"]{
      text-align:center !important;
    }


  
    /* ===============================
       DETALLE DIARIO (NUEVO LAYOUT)
       - Compromiso 65%
       - Ayer m√≠nimo (lu 16/02)
       - Hoy: header "lunes 16/02" + [NN] + observaci√≥n (1000) + üéô + üíæ
       - Alto autoajustable, compacto
       =============================== */

    /* La fila detalle no debe "comerse" ancho con padding */
    #tablaCompromisos tbody tr.fila-detalle > td{
      padding: 0 !important;
    }

    #tablaCompromisos .celda-detalle-compromisos{
      width: 100%;
      padding: 0;
    }

    #tablaCompromisos table.tabla-detalle-compromisos{
      width: 100% !important;
      max-width: 100% !important;
      table-layout: fixed;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    #tablaCompromisos table.tabla-detalle-compromisos th,
    #tablaCompromisos table.tabla-detalle-compromisos td{
      padding: 6px 8px;
      vertical-align: middle;
    }

    /* Columna Compromiso 35% del ancho total del detalle */
    #tablaCompromisos table.tabla-detalle-compromisos th:nth-child(1),
    #tablaCompromisos table.tabla-detalle-compromisos td:nth-child(1){
      width: 35%;
      text-align: left;
      white-space: normal;      /* permite wrap */
      overflow-wrap: anywhere;  /* evita overflow por palabras largas */
      line-height: 1.1;
    }

    /* Columna Ayer: lo m√°s angosta posible */
    #tablaCompromisos table.tabla-detalle-compromisos th:nth-child(2),
    #tablaCompromisos table.tabla-detalle-compromisos td:nth-child(2){
      width: 92px;              /* m√≠nimo razonable para "lu 16/02" */
      text-align: center;
      white-space: nowrap;
      padding-left: 6px;
      padding-right: 6px;
    }

    /* Columna Hoy: resto del ancho (100% - compromiso - ayer) */
    #tablaCompromisos table.tabla-detalle-compromisos th:nth-child(3),
    #tablaCompromisos table.tabla-detalle-compromisos td:nth-child(3){
      width: calc(65% - 92px);
      text-align: left;
      padding-left: 6px;
      padding-right: 6px;
    }

    /* Header de d√≠a: compacto */
    #tablaCompromisos .dia-header{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 0 !important;
    }

    #tablaCompromisos .dia-header .lbl-dia{
      font-weight: 700;
      white-space: nowrap;
    }

    /* Contenido Hoy: [NN] + textarea + botones */
    #tablaCompromisos .compromiso-dia-hoy{
      display:flex;
      align-items:flex-start;
      gap:6px;
    }

    #tablaCompromisos input.input-compromiso-dia{
      width: 34px;              /* aprox [12] */
      min-width: 34px;
      max-width: 34px;
      padding: 4px 4px;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    #tablaCompromisos textarea.input-compromiso-comentario{
      flex: 1 1 auto;
      width: 100%;
      min-width: 120px;
      resize: none;             /* auto por JS */
      padding: 5px 6px;
      line-height: 1.15;
      max-height: 4.6em;        /* ~4 l√≠neas; si excede, scroll */
      overflow: auto;
    }

    #tablaCompromisos .btn-mic-compromiso-dia,
    #tablaCompromisos .btn-guardar-compromiso-dia{
      width: 34px;
      min-width: 34px;
      height: 30px;
      line-height: 1;
      padding: 0;
      border-radius: 8px;
    }

    #tablaCompromisos .btn-mic-compromiso-dia.listening{
      outline: 2px solid rgba(220, 53, 69, 0.35);
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.10);
    }

    /* ===== Detalle diario: altura m√≠nima consistente (num√©rico vs observaci√≥n) ===== */
    #tablaCompromisos input.input-compromiso-dia{
      height: 44px;
      padding: 2px 6px;
      line-height: 1.1;
      box-sizing: border-box;
    }

    #tablaCompromisos textarea.input-compromiso-comentario{
      min-height: 44px;   /* m√≠nimo = alto del num√©rico */
      height: 30px;       /* arranca igual de compacto */
      padding: 4px 6px;
      line-height: 1.2;
      box-sizing: border-box;
      resize: none;       /* autosize por JS */
      overflow-y: hidden; /* luego JS lo cambia si supera max */
    }

    /* ===== Quitar flechas (spinner) del input num√©rico ===== */
    #tablaCompromisos input.input-compromiso-dia::-webkit-outer-spin-button,
    #tablaCompromisos input.input-compromiso-dia::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    #tablaCompromisos input.input-compromiso-dia {
      -moz-appearance: textfield; /* Firefox */
      appearance: textfield;
    }

    /* Compat: si queda el class anterior en alg√∫n lado */
    #tablaCompromisos textarea.input-compromiso-obs{
      height: 44px;
      min-height: 44px;
      box-sizing: border-box;
      resize: none;
    }

    /* ===== Bot√≥n micr√≥fono (dictado) minimalista: sin fondo azul ===== */
    #tablaCompromisos .btn-mic-compromiso-dia{
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 6px 10px;
    }
    #tablaCompromisos .btn-mic-compromiso-dia:hover{
      background: rgba(0,0,0,0.06) !important;
      border-radius: 10px;
    }
    #tablaCompromisos .btn-mic-compromiso-dia.listening{
      background: rgba(220, 53, 69, 0.10) !important; /* feedback suave */
      border-radius: 10px;
    }

    /* ===== DIVISOR DEFINITIVO AYER | HOY (visible s√≠ o s√≠) =====
       Se aplica por estructura (2da columna del detalle), no por clases.
       Usamos box-shadow inset para evitar que border-collapse "se la coma".
    */
    #tablaCompromisos table.tabla-detalle-compromisos th:nth-child(2),
    #tablaCompromisos table.tabla-detalle-compromisos td:nth-child(2){
      box-shadow: inset -2px 0 0 rgba(25,84,140,0.18) !important;
    }

  </style>
</head>

<body>

<section id="modulo-vendedores">
  <div class="tarjeta-principal">

    <div class="modulo-header">
      <h2>Gesti√≥n de Compromisos</h2>
      <button class="btn-volver" id="btnVolver">‚Üê Volver</button>
    </div>

    <div class="acciones-vendedores" style="justify-content:flex-start;">
      <div class="filtros-vendedores" style="gap:8px; justify-content:flex-start;">
        <label style="font-size:0.9rem;">
          Semana de compromiso:
          <input type="date" id="inputFechaBaseSemana" style="padding:4px 6px;" />
        </label>

        <span id="labelRangoSemana" style="font-size:0.9rem; font-weight:600; margin-left:20px;"></span>
      </div>
    </div>

    <!-- TABLA PRINCIPAL -->
    <table id="tablaCompromisos" class="tabla-vendedores">
      <thead>
        <tr>
          <th>Vendedor</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="10" style="text-align:center;">Cargando‚Ä¶</td>
        </tr>
      </tbody>
    </table>

  </div>

  <!-- MODAL √öNICO: SEMANAL + MENSUAL -->
  <dialog id="modalCompromisos" class="modal">
    <div class="modal-contenido">
      <h3 id="tituloModalCompromisos">
        Compromiso semanal ‚Äì <span id="tituloModalCompromisoNombre">Vendedor</span>
      </h3>

      <p id="tituloModalSubtitulo" style="margin-top:4px; font-size:0.9rem; color:#555;"></p>

      <div class="tabs-modal">
        <button type="button" class="tab-btn active" id="tabSemanal" data-tab="semanal">Semanal</button>
        <button type="button" class="tab-btn" id="tabMensual" data-tab="mensual">Mensual</button>
      </div>

      <form id="formCompromisos">
        <div class="sheet active" id="sheetSemanal">
          <table class="tabla-modal" id="tablaModalTiposSemanal"></table>
        </div>

        <div class="sheet" id="sheetMensual">
          <table class="tabla-modal" id="tablaModalTiposMensual"></table>
        </div>

        <input type="hidden" id="idVendedorCompromiso" />
        <input type="hidden" id="fechaInicioSemana" />
        <input type="hidden" id="fechaFinSemana" />
        <input type="hidden" id="fechaAnclaMes" />

        <div class="modal-botones">
          <button type="submit" class="btn-guardar">Guardar</button>
          <button type="button" id="cancelarCompromiso" class="btn-cancelar">Cancelar</button>
        </div>
      </form>
    </div>
  </dialog>

</section>

<script type="module" src="../scripts/compromisos.js"></script>
<script type="module" src="../scripts/ui_modales.js"></script>

</body>
</html>
